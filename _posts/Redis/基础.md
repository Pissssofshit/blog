[toc]

## 技术选型，为什么使用Redis

## Redis 数据结构

### 基本数据结构

#### 各自的特性及使用场景

#### SortedSet是怎么实现的

##### 跳表

多级链表

### 高级数据结构

## 高可用

**主从复制**是Redis高可用服务的最基础保证。实现方案是一台主服务器负责写入，然后同步数据到多台从Redis服务器上（是一个异步过程，只能保证最终一致性)，主服务器可以读写，从服务器只能读。

#### 主从复制是怎么实现的

##### 第一次同步

###### 第一阶段

(确定主从关系)

建立连接、协商同步

* replicaof 表示服务器想要成为另一服务器的从服务器
* psync 带两个参数，分别是**主服务器的 runID** 和 **复制进度 offset** 。
  * runID，每个 Redis 服务器在启动时都会自动生产一个随机的 ID 来唯一标识自己。当从服务器和主服务器第一次同步时，因为不知道主服务器的 run ID，所以将其设置为 "?"。
  * offset，表示复制的进度，第一次同步时，其值为 -1。
* 主服务器收到 psync 命令后，会用 `FULLRESYNC` 作为响应命令返回给对方。这个响应命令会带上两个参数：主服务器的 runID 和主服务器目前的复制进度 offset。从服务器收到响应后，会记录这两个值。FULLRESYNC 响应命令的意图是采用**全量复制**的方式，也就是主服务器会把所有的数据都同步给从服务器。

第一阶段是为第二阶段的全量复制做准备

###### 第二阶段

主服务器同步数据给从服务器，具体是执行bgsave，生成RDB文件，然后传输给从服务器。在主服务器生成RDB文件、发送RDB文件给从服务器期间，主服务器新收到的写操作命令会写入到replication buffer缓冲区中。

###### 第三阶段

在主服务器生成的 RDB 文件发送完，从服务器加载完 RDB 文件后，然后将 replication buffer 缓冲区里所记录的写操作命令发送给从服务器，然后「从服务器」重新执行这些操作，至此主从服务器的数据就一致了。

至此，主从服务器的第一次同步的工作就完成了。

##### 命令传播

主从服务器在完成第一次同步后，双方之间就会维护一个 TCP 连接。

后续主服务器可以通过这个连接继续将写操作命令传播给从服务器，然后从服务器执行该命令，使得与主服务器的数据库状态相同。

而且这个连接是长连接的，目的是避免频繁的 TCP 连接和断开带来的性能开销。

上面的这个过程被称为 **基于长连接的命令传播** ，通过这种方式来保证第一次同步后的主从服务器的数据一致性。

##### 增量复制

长链接断开又恢复之后，通过psync xx 自身复制的offset 告诉主服务器自己读到哪里了。之后主服务器会把断线期间执行的写命令发送给从服务器。

###### 主服务器是怎么知道哪些是增量数据呢？

* **repl_backlog_buffer** ，是一个「 **环形** 」缓冲区,在主服务器进行命令传播的时候，不仅会将写命令发送给从服务器，还会将写命令写入到这个缓冲区中。因此 这个缓冲区里会保存着**最近**传播的写命令。
* **replication offset** ，标记上面那个缓冲区的同步进度，主从服务器都有各自的偏移量，主服务器使用 master_repl_offset 来记录自己「 *写* 」到的位置，从服务器使用 slave_repl_offset 来记录自己「 *读* 」到的位置。

网络断开后，当从服务器重新连上主服务器时，从服务器会通过 psync 命令将自己的复制偏移量 slave_repl_offset 发送给主服务器，主服务器根据自己的 master_repl_offset 和 slave_repl_offset 之间的差距，然后来决定对从服务器执行哪种同步操作：

* 如果判断出从服务器要读取的数据还在 repl_backlog_buffer 缓冲区里，那么主服务器将采用**增量同步**的方式；
* 相反，如果判断出从服务器要读取的数据已经不存在 repl_backlog_buffer 缓冲区里，那么主服务器将采用**全量同步**的方式。

~~哨兵集群，哨兵必须用三个实例去保证自己的健壮性的，哨兵+主从并不能保证数据不丢失，但是可以保证集群的高可用。~~

### 主从复制(面试版)

首先如果是第一次同步，从服务器会用replicaof命令形成主从服务器的关系，主服务器会告诉从服务器自己的runID(标识)，复制进度（这个是什么？)，这是为后面的全量复制做准备。主服务器会利用bgsave去异步生成RDB文件并将其传输给从服务器，从服务器清空当前数据，然后载入RDB。在RDB生成、传输期间，主服务器收到的写操作会写入replication buffer缓冲区中，在从服务器加载完RDB后，会把这些命令发送给从服务器，然后让从服务器重新执行这些操作，至此主从服务器的数据就保持一致了。

主从服务器在完成第一次同步后，双方之间就会维护一个 TCP 连接。后续主服务器可以通过这个连接继续将写操作命令传播给从服务器，然后从服务器执行该命令，使得与主服务器的数据库状态相同。而且这个连接是长连接的，目的是避免频繁的 TCP 连接和断开带来的性能开销。

### 哨兵

哨兵节点主要负责三件事情： **监控、选主、通知** 。

#### 如何判断节点故障

每隔一秒发送心跳，没有响应则标记（主节点)为“主观下线”。

当一个哨兵判断主节点为主管下线之后，就会像其他哨兵发起命令，做出赞成或不赞成的相应。

赞成票数达到哨兵配置文件中的quorum配置项设定的值后，这时主节点就会被哨兵标记为客观下线。之后就是从多个从节点中选出一个来做新主节点。

#### 选举过程

TODO

#### 主从故障转移过程

TODO

内存淘汰机制

Redis的过期策略，是有定期删除+惰性删除两种。

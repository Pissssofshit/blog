---
title: 聊聊ACID中的C
category: [数据库]
tags: [数据库,ACID]
layout: post
---
一致性（Consistency）确保事务将数据库从一个一致的状态转移到另一个一致的状态。
一致性意味着：
1. 一致的状态：一个数据库的一致状态是指它符合所有预定义规则和约束的状态。这些规则包括数据类型限制、唯一性约束、外键约束、自定义的业务规则等。简而言之，数据库的数据在一致状态下是正确的、有效的，并符合业务和数据模型的要求。
2. 状态转移：当执行一个事务（一系列的数据库操作，旨在完成某个具体的业务任务）时，它可能会读取、修改、添加或删除数据库中的数据。这个过程实际上是数据库状态的一个转移，从执行事务之前的状态转移到执行事务之后的状态。
3. 保持一致性：数据库系统确保在事务执行过程中，即使发生错误或中断，也不会导致数据违反任何约束或规则，从而保持数据的一致性。如果事务不能成功完成并满足所有约束条件，数据库系统将撤销（回滚）事务的所有操作，返回到事务开始之前的一致状态，这样就确保了数据库始终处于一致的状态中。

### 一致性受损引起的问题
一致性的实现要依赖于隔离性。如果没有适当的隔离级别，就可能会遇到各种并发访问问题，从而导致数据一致性问题。下面是一些典型的并发访问问题，**从数据一致性的角度看并行事务在不同隔离级别造成的问题**：
脏读（Dirty Reads）
- 定义：一个事务读取到了另一个事务未提交的数据。如果那个事务回滚，读取到的数据就是无效的。
- 一致性问题：因为读取到了不应该可见的数据，数据库的状态可能反映了一个从未真正发生过的状态，违反了一致性原则。

不可重复读（Non-repeatable Reads）
- 定义：在同一事务内，多次读取同一数据集合返回不同的结果集，这是因为另一个并发事务在两次读取之间修改了那些数据。
- 一致性问题：如果事务不能依赖于其在一个一致性视图上的操作，就可能导致基于错误信息的决策，破坏了数据的准确性和可靠性。

幻读（Phantom Reads）
- 定义：在同一事务内执行相同的查询，返回了不同的行数。这是因为另一个并发事务插入或删除了满足查询条件的行。
- 一致性问题：幻读进一步扩展了不可重复读的问题，使得事务难以维护对数据集合的一致性控制，进而可能导致基于错误的数据集操作。

### 如何确保一致性
- 数据约束（如主键、外键、唯一性、检查约束）保证了数据符合业务规则，比如防止无效的账户号码或保证账户余额不会跌破零。
- 事务管理确保了即使在多个步骤或操作组成的复杂业务流程中，数据的一致性也能被保持。通过事务的原子性保证，整个事务要么完全成功，要么完全回滚，不存在中间状态，确保了每一步操作都基于正确且最新的信息。
- 并发控制（包括锁和隔离级别）避免了并发事务之间的干扰，确保了在一个事务视图中看到的数据是一致的，防止了诸如脏读、不可重复读或幻读等现象的发生，从而维护了数据库状态的连续性和逻辑一致性。

### 技术实现
可以知道，一致性的实现在很大程度上依赖隔离性。
写前日志（Write-Ahead Logging, WAL）确保了即使在系统故障的情况下，已提交事务的更改也能被恢复，维护了数据的一致性。此外，多版本并发控制（MVCC）通过为每个读操作提供数据的快照版本，允许读写操作并发进行，同时避免了不一致读。
- 锁：数据库使用锁和其他并发控制机制来确保在并发事务的情况下，每个事务都能在一个隔离的环境中运行，避免了并发访问导致的数据不一致问题。
- 约束：通过应用数据完整性约束（如外键、检查约束等），数据库管理系统能够自动检查并确保事务执行的结果不会违反这些约束，从而维护数据的一致性。
